// SPDX-License-Identifier: GPL-2.0
/*
 * Rockchip RK3288 VPU codec driver
 *
 * Copyright (c) 2014 Rockchip Electronics Co., Ltd.
 *	Hertz Wong <hertz.wong@rock-chips.com>
 *	Herman Chen <herman.chen@rock-chips.com>
 *
 * Copyright (C) 2014 Google, Inc.
 *	Tomasz Figa <tfiga@chromium.org>
 */

#include <linux/types.h>
#include <media/v4l2-h264.h>
#include <media/v4l2-mem2mem.h>

#include "hantro.h"
#include "hantro_hw.h"

/* Size with u32 units. */
#define CABAC_INIT_BUFFER_SIZE		(460 * 2)
#define POC_BUFFER_SIZE			34
#define SCALING_LIST_SIZE		(6 * 16 + 2 * 64)

/*
 * For valid and long term reference marking, index are reversed, so bit 31
 * indicates the status of the picture 0.
 */
#define REF_BIT(i)			BIT(32 - 1 - (i))

/* Data structure describing auxiliary buffer format. */
struct hantro_h264_dec_priv_tbl {
	u32 cabac_table[CABAC_INIT_BUFFER_SIZE];
	u32 poc[POC_BUFFER_SIZE];
	u8 scaling_list[SCALING_LIST_SIZE];
};

/*
 * Constant CABAC table.
 * From drivers/media/platform/rk3288-vpu/rk3288_vpu_hw_h264d.c
 * in https://chromium.googlesource.com/chromiumos/third_party/kernel,
 * chromeos-3.14 branch.
 */
static const u32 h264_cabac_table[] = {
	0x14f10236, 0x034a14f1, 0x0236034a, 0xe47fe968, 0xfa35ff36, 0x07330000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x0029003f, 0x003f003f, 0xf7530456, 0x0061f948, 0x0d29033e, 0x000b0137,
	0x0045ef7f, 0xf3660052, 0xf94aeb6b, 0xe57fe17f, 0xe87fee5f, 0xe57feb72,
	0xe27fef7b, 0xf473f07a, 0xf573f43f, 0xfe44f154, 0xf368fd46, 0xf85df65a,
	0xe27fff4a, 0xfa61f95b, 0xec7ffc38, 0xfb52f94c, 0xea7df95d, 0xf557fd4d,
	0xfb47fc3f, 0xfc44f454, 0xf93ef941, 0x083d0538, 0xfe420140, 0x003dfe4e,
	0x01320734, 0x0a23002c, 0x0b26012d, 0x002e052c, 0x1f110133, 0x07321c13,
	0x10210e3e, 0xf36cf164, 0xf365f35b, 0xf45ef658, 0xf054f656, 0xf953f357,
	0xed5e0146, 0x0048fb4a, 0x123bf866, 0xf164005f, 0xfc4b0248, 0xf54bfd47,
	0x0f2ef345, 0x003e0041, 0x1525f148, 0x09391036, 0x003e0c48, 0x18000f09,
	0x08190d12, 0x0f090d13, 0x0a250c12, 0x061d1421, 0x0f1e042d, 0x013a003e,
	0x073d0c26, 0x0b2d0f27, 0x0b2a0d2c, 0x102d0c29, 0x0a311e22, 0x122a0a37,
	0x1133112e, 0x00591aed, 0x16ef1aef, 0x1ee71cec, 0x21e925e5, 0x21e928e4,
	0x26ef21f5, 0x28f129fa, 0x26012911, 0x1efa1b03, 0x1a1625f0, 0x23fc26f8,
	0x26fd2503, 0x26052a00, 0x23102716, 0x0e301b25, 0x153c0c44, 0x0261fd47,
	0xfa2afb32, 0xfd36fe3e, 0x003a013f, 0xfe48ff4a, 0xf75bfb43, 0xfb1bfd27,
	0xfe2c002e, 0xf040f844, 0xf64efa4d, 0xf656f45c, 0xf137f63c, 0xfa3efc41,
	0xf449f84c, 0xf950f758, 0xef6ef561, 0xec54f54f, 0xfa49fc4a, 0xf356f360,
	0xf561ed75, 0xf84efb21, 0xfc30fe35, 0xfd3ef347, 0xf64ff456, 0xf35af261,
	0x0000fa5d, 0xfa54f84f, 0x0042ff47, 0x003efe3c, 0xfe3bfb4b, 0xfd3efc3a,
	0xf742ff4f, 0x00470344, 0x0a2cf93e, 0x0f240e28, 0x101b0c1d, 0x012c1424,
	0x1220052a, 0x01300a3e, 0x112e0940, 0xf468f561, 0xf060f958, 0xf855f955,
	0xf755f358, 0x0442fd4d, 0xfd4cfa4c, 0x0a3aff4c, 0xff53f963, 0xf25f025f,
	0x004cfb4a, 0x0046f54b, 0x01440041, 0xf249033e, 0x043eff44, 0xf34b0b37,
	0x05400c46, 0x0f060613, 0x07100c0e, 0x120d0d0b, 0x0d0f0f10, 0x0c170d17,
	0x0f140e1a, 0x0e2c1128, 0x112f1811, 0x15151916, 0x1f1b161d, 0x13230e32,
	0x0a39073f, 0xfe4dfc52, 0xfd5e0945, 0xf46d24dd, 0x24de20e6, 0x25e22ce0,
	0x22ee22f1, 0x28f121f9, 0x23fb2100, 0x2602210d, 0x17230d3a, 0x1dfd1a00,
	0x161e1ff9, 0x23f122fd, 0x220324ff, 0x2205200b, 0x2305220c, 0x270b1e1d,
	0x221a1d27, 0x13421f15, 0x1f1f1932, 0xef78ec70, 0xee72f555, 0xf15cf259,
	0xe647f151, 0xf2500044, 0xf246e838, 0xe944e832, 0xf54a17f3, 0x1af328f1,
	0x31f22c03, 0x2d062c22, 0x21361352, 0xfd4bff17, 0x0122012b, 0x0036fe37,
	0x003d0140, 0x0044f75c, 0xf26af361, 0xf15af45a, 0xee58f649, 0xf74ff256,
	0xf649f646, 0xf645fb42, 0xf740fb3a, 0x023b15f6, 0x18f51cf8, 0x1cff1d03,
	0x1d092314, 0x1d240e43, 0x14f10236, 0x034a14f1, 0x0236034a, 0xe47fe968,
	0xfa35ff36, 0x07331721, 0x17021500, 0x01090031, 0xdb760539, 0xf34ef541,
	0x013e0c31, 0xfc491132, 0x1240092b, 0x1d001a43, 0x105a0968, 0xd27fec68,
	0x0143f34e, 0xf541013e, 0xfa56ef5f, 0xfa3d092d, 0xfd45fa51, 0xf5600637,
	0x0743fb56, 0x0258003a, 0xfd4cf65e, 0x05360445, 0xfd510058, 0xf943fb4a,
	0xfc4afb50, 0xf948013a, 0x0029003f, 0x003f003f, 0xf7530456, 0x0061f948,
	0x0d29033e, 0x002dfc4e, 0xfd60e57e, 0xe462e765, 0xe943e452, 0xec5ef053,
	0xea6eeb5b, 0xee66f35d, 0xe37ff95c, 0xfb59f960, 0xf36cfd2e, 0xff41ff39,
	0xf75dfd4a, 0xf75cf857, 0xe97e0536, 0x063c063b, 0x0645ff30, 0x0044fc45,
	0xf858fe55, 0xfa4eff4b, 0xf94d0236, 0x0532fd44, 0x0132062a, 0xfc51013f,
	0xfc460043, 0x0239fe4c, 0x0b230440, 0x013d0b23, 0x12190c18, 0x0d1d0d24,
	0xf65df949, 0xfe490d2e, 0x0931f964, 0x09350235, 0x0535fe3d, 0x00380038,
	0xf33ffb3c, 0xff3e0439, 0xfa450439, 0x0e270433, 0x0d440340, 0x013d093f,
	0x07321027, 0x052c0434, 0x0b30fb3c, 0xff3b003b, 0x1621052c, 0x0e2bff4e,
	0x003c0945, 0x0b1c0228, 0x032c0031, 0x002e022c, 0x0233002f, 0x0427023e,
	0x062e0036, 0x0336023a, 0x043f0633, 0x06390735, 0x06340637, 0x0b2d0e24,
	0x0835ff52, 0x0737fd4e, 0x0f2e161f, 0xff541907, 0x1ef91c03, 0x1c042000,
	0x22ff1e06, 0x1e062009, 0x1f131a1b, 0x1a1e2514, 0x1c221146, 0x0143053b,
	0x0943101e, 0x12201223, 0x161d181f, 0x1726122b, 0x14290b3f, 0x093b0940,
	0xff5efe59, 0xf76cfa4c, 0xfe2c002d, 0x0034fd40, 0xfe3bfc46, 0xfc4bf852,
	0xef66f74d, 0x0318002a, 0x00300037, 0xfa3bf947, 0xf453f557, 0xe277013a,
	0xfd1dff24, 0x0126022b, 0xfa37003a, 0x0040fd4a, 0xf65a0046, 0xfc1d051f,
	0x072a013b, 0xfe3afd48, 0xfd51f561, 0x003a0805, 0x0a0e0e12, 0x0d1b0228,
	0x003afd46, 0xfa4ff855, 0x0000f36a, 0xf06af657, 0xeb72ee6e, 0xf262ea6e,
	0xeb6aee67, 0xeb6be96c, 0xe670f660, 0xf45ffb5b, 0xf75dea5e, 0xfb560943,
	0xfc50f655, 0xff46073c, 0x093a053d, 0x0c320f32, 0x12311136, 0x0a29072e,
	0xff330731, 0x08340929, 0x062f0237, 0x0d290a2c, 0x06320535, 0x0d31043f,
	0x0640fe45, 0xfe3b0646, 0x0a2c091f, 0x0c2b0335, 0x0e220a26, 0xfd340d28,
	0x1120072c, 0x07260d32, 0x0a391a2b, 0x0e0b0b0e, 0x090b120b, 0x150917fe,
	0x20f120f1, 0x22eb27e9, 0x2adf29e1, 0x2ee426f4, 0x151d2de8, 0x35d330e6,
	0x41d52bed, 0x27f61e09, 0x121a141b, 0x0039f252, 0xfb4bed61, 0xdd7d1b00,
	0x1c001ffc, 0x1b062208, 0x1e0a1816, 0x21131620, 0x1a1f1529, 0x1a2c172f,
	0x10410e47, 0x083c063f, 0x11411518, 0x17141a17, 0x1b201c17, 0x1c181728,
	0x18201c1d, 0x172a1339, 0x1635163d, 0x0b560c28, 0x0b330e3b, 0xfc4ff947,
	0xfb45f746, 0xf842f644, 0xed49f445, 0xf046f143, 0xec3eed46, 0xf042ea41,
	0xec3f09fe, 0x1af721f7, 0x27f929fe, 0x2d033109, 0x2d1b243b, 0xfa42f923,
	0xf92af82d, 0xfb30f438, 0xfa3cfb3e, 0xf842f84c, 0xfb55fa51, 0xf64df951,
	0xef50ee49, 0xfc4af653, 0xf747f743, 0xff3df842, 0xf242003b, 0x023b15f3,
	0x21f227f9, 0x2efe3302, 0x3c063d11, 0x37222a3e, 0x14f10236, 0x034a14f1,
	0x0236034a, 0xe47fe968, 0xfa35ff36, 0x07331619, 0x22001000, 0xfe090429,
	0xe3760241, 0xfa47f34f, 0x05340932, 0xfd460a36, 0x1a221316, 0x28003902,
	0x29241a45, 0xd37ff165, 0xfc4cfa47, 0xf34f0534, 0x0645f35a, 0x0034082b,
	0xfe45fb52, 0xf660023b, 0x024bfd57, 0xfd640138, 0xfd4afa55, 0x003bfd51,
	0xf956fb5f, 0xff42ff4d, 0x0146fe56, 0xfb48003d, 0x0029003f, 0x003f003f,
	0xf7530456, 0x0061f948, 0x0d29033e, 0x0d0f0733, 0x0250d97f, 0xee5bef60,
	0xe651dd62, 0xe866e961, 0xe577e863, 0xeb6eee66, 0xdc7f0050, 0xfb59f95e,
	0xfc5c0027, 0x0041f154, 0xdd7ffe49, 0xf468f75b, 0xe17f0337, 0x07380737,
	0x083dfd35, 0x0044f94a, 0xf758f367, 0xf35bf759, 0xf25cf84c, 0xf457e96e,
	0xe869f64e, 0xec70ef63, 0xb27fba7f, 0xce7fd27f, 0xfc42fb4e, 0xfc47f848,
	0x023bff37, 0xf946fa4b, 0xf859de77, 0xfd4b2014, 0x1e16d47f, 0x0036fb3d,
	0x003aff3c, 0xfd3df843, 0xe754f24a, 0xfb410534, 0x0239003d, 0xf745f546,
	0x1237fc47, 0x003a073d, 0x09291219, 0x0920052b, 0x092f002c, 0x0033022e,
	0x1326fc42, 0x0f260c2a, 0x09220059, 0x042d0a1c, 0x0a1f21f5, 0x34d5120f,
	0x1c0023ea, 0x26e72200, 0x27ee20f4, 0x66a20000, 0x38f121fc, 0x1d0a25fb,
	0x33e327f7, 0x34de45c6, 0x43c12cfb, 0x200737e3, 0x20010000, 0x1b2421e7,
	0x22e224e4, 0x26e426e5, 0x22ee23f0, 0x22f220f8, 0x25fa2300, 0x1e0a1c12,
	0x1a191d29, 0x004b0248, 0x084d0e23, 0x121f1123, 0x151e112d, 0x142a122d,
	0x1b1a1036, 0x07421038, 0x0b490a43, 0xf674e970, 0xf147f93d, 0x0035fb42,
	0xf54df750, 0xf754f657, 0xde7feb65, 0xfd27fb35, 0xf93df54b, 0xf14def5b,
	0xe76be76f, 0xe47af54c, 0xf62cf634, 0xf639f73a, 0xf048f945, 0xfc45fb4a,
	0xf7560242, 0xf7220120, 0x0b1f0534, 0xfe37fe43, 0x0049f859, 0x03340704,
	0x0a081108, 0x10130325, 0xff3dfb49, 0xff46fc4e, 0x0000eb7e, 0xe97cec6e,
	0xe67ee77c, 0xef69e579, 0xe575ef66, 0xe675e574, 0xdf7af65f, 0xf264f85f,
	0xef6fe472, 0xfa59fe50, 0xfc52f755, 0xf851ff48, 0x05400143, 0x09380045,
	0x01450745, 0xf945fa43, 0xf04dfe40, 0x023dfa43, 0xfd400239, 0xfd41fd42,
	0x003e0933, 0xff42fe47, 0xfe4bff46, 0xf7480e3c, 0x1025002f, 0x12230b25,
	0x0c290a29, 0x02300c29, 0x0d29003b, 0x03321328, 0x03421232, 0x13fa12fa,
	0x0e001af4, 0x1ff021e7, 0x21ea25e4, 0x27e22ae2, 0x2fd62ddc, 0x31de29ef,
	0x200945b9, 0x3fc142c0, 0x4db636d9, 0x34dd29f6, 0x240028ff, 0x1e0e1c1a,
	0x17250c37, 0x0b4125df, 0x27dc28db, 0x26e22edf, 0x2ae228e8, 0x31e326f4,
	0x28f626fd, 0x2efb1f14, 0x1d1e192c, 0x0c300b31, 0x1a2d1616, 0x17161b15,
	0x21141a1c, 0x1e181b22, 0x122a1927, 0x12320c46, 0x15360e47, 0x0b531920,
	0x15311536, 0xfb55fa51, 0xf64df951, 0xef50ee49, 0xfc4af653, 0xf747f743,
	0xff3df842, 0xf242003b, 0x023b11f6, 0x20f32af7, 0x31fb3500, 0x4003440a,
	0x421b2f39, 0xfb470018, 0xff24fe2a, 0xfe34f739, 0xfa3ffc41, 0xfc43f952,
	0xfd51fd4c, 0xf948fa4e, 0xf448f244, 0xfd46fa4c, 0xfb42fb3e, 0x0039fc3d,
	0xf73c0136, 0x023a11f6, 0x20f32af7, 0x31fb3500, 0x4003440a, 0x421b2f39,
	0x14f10236, 0x034a14f1, 0x0236034a, 0xe47fe968, 0xfa35ff36, 0x07331d10,
	0x19000e00, 0xf633fd3e, 0xe5631a10, 0xfc55e866, 0x05390639, 0xef490e39,
	0x1428140a, 0x1d003600, 0x252a0c61, 0xe07fea75, 0xfe4afc55, 0xe8660539,
	0xfa5df258, 0xfa2c0437, 0xf559f167, 0xeb741339, 0x143a0454, 0x0660013f,
	0xfb55f36a, 0x053f064b, 0xfd5aff65, 0x0337fc4f, 0xfe4bf461, 0xf932013c,
	0x0029003f, 0x003f003f, 0xf7530456, 0x0061f948, 0x0d29033e, 0x0722f758,
	0xec7fdc7f, 0xef5bf25f, 0xe754e756, 0xf459ef5b, 0xe17ff24c, 0xee67f35a,
	0xdb7f0b50, 0x054c0254, 0x054efa37, 0x043df253, 0xdb7ffb4f, 0xf568f55b,
	0xe27f0041, 0xfe4f0048, 0xfc5cfa38, 0x0344f847, 0xf362fc56, 0xf458fb52,
	0xfd48fc43, 0xf848f059, 0xf745ff3b, 0x05420439, 0xfc47fe47, 0x023aff4a,
	0xfc2cff45, 0x003ef933, 0xfc2ffa2a, 0xfd29fa35, 0x084cf74e, 0xf5530934,
	0x0043fb5a, 0x0143f148, 0xfb4bf850, 0xeb53eb40, 0xf31fe740, 0xe35e094b,
	0x113ff84a, 0xfb23fe1b, 0x0d5b0341, 0xf945084d, 0xf642033e, 0xfd44ec51,
	0x001e0107, 0xfd17eb4a, 0x1042e97c, 0x11252cee, 0x32deea7f, 0x0427002a,
	0x07220b1d, 0x081f0625, 0x072a0328, 0x08210d2b, 0x0d24042f, 0x0337023a,
	0x063c082c, 0x0b2c0e2a, 0x07300438, 0x04340d25, 0x0931133a, 0x0a300c2d,
	0x00451421, 0x083f23ee, 0x21e71cfd, 0x180a1b00, 0x22f234d4, 0x27e81311,
	0x1f19241d, 0x1821220f, 0x1e141649, 0x1422131f, 0x1b2c1310, 0x0f240f24,
	0x151c1915, 0x1e141f0c, 0x1b10182a, 0x005d0e38, 0x0f391a26, 0xe87fe873,
	0xea52f73e, 0x0035003b, 0xf255f359, 0xf35ef55c, 0xe37feb64, 0xf239f443,
	0xf547f64d, 0xeb55f058, 0xe968f162, 0xdb7ff652, 0xf830f83d, 0xf842f946,
	0xf24bf64f, 0xf753f45c, 0xee6cfc4f, 0xea45f04b, 0xfe3a013a, 0xf34ef753,
	0xfc51f363, 0xf351fa26, 0xf33efa3a, 0xfe3bf049, 0xf64cf356, 0xf753f657,
	0x0000ea7f, 0xe77fe778, 0xe57fed72, 0xe975e776, 0xe675e871, 0xe476e178,
	0xdb7cf65e, 0xf166f663, 0xf36ace7f, 0xfb5c1139, 0xfb56f35e, 0xf45bfe4d,
	0x0047ff49, 0x0440f951, 0x05400f39, 0x01430044, 0xf6430144, 0x004d0240,
	0x0044fb4e, 0x0737053b, 0x02410e36, 0x0f2c053c, 0x0246fe4c, 0xee560c46,
	0x0540f446, 0x0b370538, 0x00450241, 0xfa4a0536, 0x0736fa4c, 0xf552fe4d,
	0xfe4d192a, 0x11f310f7, 0x11f41beb, 0x25e229d8, 0x2ad730d1, 0x27e02ed8,
	0x34cd2ed7, 0x34d92bed, 0x200b3dc9, 0x38d23ece, 0x51bd2dec, 0x23fe1c0f,
	0x22012701, 0x1e111426, 0x122d0f36, 0x004f24f0, 0x25f225ef, 0x2001220f,
	0x1d0f1819, 0x22161f10, 0x23121f1c, 0x2129241c, 0x1b2f153e, 0x121f131a,
	0x24181817, 0x1b10181e, 0x1f1d1629, 0x162a103c, 0x0f340e3c, 0x034ef07b,
	0x15351638, 0x193d1521, 0x1332113d, 0xfd4ef84a, 0xf748f648, 0xee4bf447,
	0xf53ffb46, 0xef4bf248, 0xf043f835, 0xf23bf734, 0xf54409fe, 0x1ef61ffc,
	0x21ff2107, 0x1f0c2517, 0x1f261440, 0xf747f925, 0xf82cf531, 0xf638f43b,
	0xf83ff743, 0xfa44f64f, 0xfd4ef84a, 0xf748f648, 0xee4bf447, 0xf53ffb46,
	0xef4bf248, 0xf043f835, 0xf23bf734, 0xf54409fe, 0x1ef61ffc, 0x21ff2107,
	0x1f0c2517, 0x1f261440
};

/*
 * CABAC tables for the encoder.
 * From drivers/staging/media/hantro/rk3399_vpu_hw_h264_enc.c
 * in https://chromium.googlesource.com/chromiumos/third_party/kernel,
 * chromeos-5.10 branch.
 */
static const s32 h264_context_init_intra[HANTRO_H264_CABAC_CV_NUM][2] = {
	/* 0 -> 10 */
	{ 20, -15 }, { 2, 54 }, { 3, 74 }, { 20, -15 },
	{ 2, 54 }, { 3, 74 }, { -28, 127 }, { -23, 104 },
	{ -6, 53 }, { -1, 54 }, { 7, 51 },
	/* 11 -> 23 unused for I */
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 },
	/* 24 -> 39 */
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	/* 40 -> 53 */
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 },
	/* 54 -> 59 */
	{ 0, 0 }, { 0, 0 }, { 0, 0 }, { 0, 0 },
	{ 0, 0 }, { 0, 0 },
	/* 60 -> 69 */
	{ 0, 41 }, { 0, 63 }, { 0, 63 }, { 0, 63 },
	{ -9, 83 }, { 4, 86 }, { 0, 97 }, { -7, 72 },
	{ 13, 41 }, { 3, 62 },
	/* 70 -> 87 */
	{ 0, 11 }, { 1, 55 }, { 0, 69 }, { -17, 127 },
	{ -13, 102 }, { 0, 82 }, { -7, 74 }, { -21, 107 },
	{ -27, 127 }, { -31, 127 }, { -24, 127 }, { -18, 95 },
	{ -27, 127 }, { -21, 114 }, { -30, 127 }, { -17, 123 },
	{ -12, 115 }, { -16, 122 },
	/* 88 -> 104 */
	{ -11, 115 }, { -12, 63 }, { -2, 68 }, { -15, 84 },
	{ -13, 104 }, { -3, 70 }, { -8, 93 }, { -10, 90 },
	{ -30, 127 }, { -1, 74 }, { -6, 97 }, { -7, 91 },
	{ -20, 127 }, { -4, 56 }, { -5, 82 }, { -7, 76 },
	{ -22, 125 },
	/* 105 -> 135 */
	{ -7, 93 }, { -11, 87 }, { -3, 77 }, { -5, 71 },
	{ -4, 63 }, { -4, 68 }, { -12, 84 }, { -7, 62 },
	{ -7, 65 }, { 8, 61 }, { 5, 56 }, { -2, 66 },
	{ 1, 64 }, { 0, 61 }, { -2, 78 }, { 1, 50 },
	{ 7, 52 }, { 10, 35 }, { 0, 44 }, { 11, 38 },
	{ 1, 45 }, { 0, 46 }, { 5, 44 }, { 31, 17 },
	{ 1, 51 }, { 7, 50 }, { 28, 19 }, { 16, 33 },
	{ 14, 62 }, { -13, 108 }, { -15, 100 },
	/* 136 -> 165 */
	{ -13, 101 }, { -13, 91 }, { -12, 94 }, { -10, 88 },
	{ -16, 84 }, { -10, 86 }, { -7, 83 }, { -13, 87 },
	{ -19, 94 }, { 1, 70 }, { 0, 72 }, { -5, 74 },
	{ 18, 59 }, { -8, 102 }, { -15, 100 }, { 0, 95 },
	{ -4, 75 }, { 2, 72 }, { -11, 75 }, { -3, 71 },
	{ 15, 46 }, { -13, 69 }, { 0, 62 }, { 0, 65 },
	{ 21, 37 }, { -15, 72 }, { 9, 57 }, { 16, 54 },
	{ 0, 62 }, { 12, 72 },
	/* 166 -> 196 */
	{ 24, 0 }, { 15, 9 }, { 8, 25 }, { 13, 18 },
	{ 15, 9 }, { 13, 19 }, { 10, 37 }, { 12, 18 },
	{ 6, 29 }, { 20, 33 }, { 15, 30 }, { 4, 45 },
	{ 1, 58 }, { 0, 62 }, { 7, 61 }, { 12, 38 },
	{ 11, 45 }, { 15, 39 }, { 11, 42 }, { 13, 44 },
	{ 16, 45 }, { 12, 41 }, { 10, 49 }, { 30, 34 },
	{ 18, 42 }, { 10, 55 }, { 17, 51 }, { 17, 46 },
	{ 0, 89 }, { 26, -19 }, { 22, -17 },
	/* 197 -> 226 */
	{ 26, -17 }, { 30, -25 }, { 28, -20 }, { 33, -23 },
	{ 37, -27 }, { 33, -23 }, { 40, -28 }, { 38, -17 },
	{ 33, -11 }, { 40, -15 }, { 41, -6 }, { 38, 1 },
	{ 41, 17 }, { 30, -6 }, { 27, 3 }, { 26, 22 },
	{ 37, -16 }, { 35, -4 }, { 38, -8 }, { 38, -3 },
	{ 37, 3 }, { 38, 5 }, { 42, 0 }, { 35, 16 },
	{ 39, 22 }, { 14, 48 }, { 27, 37 }, { 21, 60 },
	{ 12, 68 }, { 2, 97 },
	/* 227 -> 251 */
	{ -3, 71 }, { -6, 42 }, { -5, 50 }, { -3, 54 },
	{ -2, 62 }, { 0, 58 }, { 1, 63 }, { -2, 72 },
	{ -1, 74 }, { -9, 91 }, { -5, 67 }, { -5, 27 },
	{ -3, 39 }, { -2, 44 }, { 0, 46 }, { -16, 64 },
	{ -8, 68 }, { -10, 78 }, { -6, 77 }, { -10, 86 },
	{ -12, 92 }, { -15, 55 }, { -10, 60 }, { -6, 62 },
	{ -4, 65 },
	/* 252 -> 275 */
	{ -12, 73 }, { -8, 76 }, { -7, 80 }, { -9, 88 },
	{ -17, 110 }, { -11, 97 }, { -20, 84 }, { -11, 79 },
	{ -6, 73 }, { -4, 74 }, { -13, 86 }, { -13, 96 },
	{ -11, 97 }, { -19, 117 }, { -8, 78 }, { -5, 33 },
	{ -4, 48 }, { -2, 53 }, { -3, 62 }, { -13, 71 },
	{ -10, 79 }, { -12, 86 }, { -13, 90 }, { -14, 97 },
	/* 276 special case, bypass used */
	{ 0, 0 },
	/* 277 -> 307 */
	{ -6, 93 }, { -6, 84 }, { -8, 79 }, { 0, 66 },
	{ -1, 71 }, { 0, 62 }, { -2, 60 }, { -2, 59 },
	{ -5, 75 }, { -3, 62 }, { -4, 58 }, { -9, 66 },
	{ -1, 79 }, { 0, 71 }, { 3, 68 }, { 10, 44 },
	{ -7, 62 }, { 15, 36 }, { 14, 40 }, { 16, 27 },
	{ 12, 29 }, { 1, 44 }, { 20, 36 }, { 18, 32 },
	{ 5, 42 }, { 1, 48 }, { 10, 62 }, { 17, 46 },
	{ 9, 64 }, { -12, 104 }, { -11, 97 },
	/* 308 -> 337 */
	{ -16, 96 }, { -7, 88 }, { -8, 85 }, { -7, 85 },
	{ -9, 85 }, { -13, 88 }, { 4, 66 }, { -3, 77 },
	{ -3, 76 }, { -6, 76 }, { 10, 58 }, { -1, 76 },
	{ -1, 83 }, { -7, 99 }, { -14, 95 }, { 2, 95 },
	{ 0, 76 }, { -5, 74 }, { 0, 70 }, { -11, 75 },
	{ 1, 68 }, { 0, 65 }, { -14, 73 }, { 3, 62 },
	{ 4, 62 }, { -1, 68 }, { -13, 75 }, { 11, 55 },
	{ 5, 64 }, { 12, 70 },
	/* 338 -> 368 */
	{ 15, 6 }, { 6, 19 }, { 7, 16 }, { 12, 14 },
	{ 18, 13 }, { 13, 11 }, { 13, 15 }, { 15, 16 },
	{ 12, 23 }, { 13, 23 }, { 15, 20 }, { 14, 26 },
	{ 14, 44 }, { 17, 40 }, { 17, 47 }, { 24, 17 },
	{ 21, 21 }, { 25, 22 }, { 31, 27 }, { 22, 29 },
	{ 19, 35 }, { 14, 50 }, { 10, 57 }, { 7, 63 },
	{ -2, 77 }, { -4, 82 }, { -3, 94 }, { 9, 69 },
	{ -12, 109 }, { 36, -35 }, { 36, -34 },
	/* 369 -> 398 */
	{ 32, -26 }, { 37, -30 }, { 44, -32 }, { 34, -18 },
	{ 34, -15 }, { 40, -15 }, { 33, -7 }, { 35, -5 },
	{ 33, 0 }, { 38, 2 }, { 33, 13 }, { 23, 35 },
	{ 13, 58 }, { 29, -3 }, { 26, 0 }, { 22, 30 },
	{ 31, -7 }, { 35, -15 }, { 34, -3 }, { 34, 3 },
	{ 36, -1 }, { 34, 5 }, { 32, 11 }, { 35, 5 },
	{ 34, 12 }, { 39, 11 }, { 30, 29 }, { 34, 26 },
	{ 29, 39 }, { 19, 66 },
	/* 399 -> 435 */
	{ 31, 21 }, { 31, 31 }, { 25, 50 },
	{ -17, 120 }, { -20, 112 }, { -18, 114 }, { -11, 85 },
	{ -15, 92 }, { -14, 89 }, { -26, 71 }, { -15, 81 },
	{ -14, 80 }, { 0, 68 }, { -14, 70 }, { -24, 56 },
	{ -23, 68 }, { -24, 50 }, { -11, 74 }, { 23, -13 },
	{ 26, -13 }, { 40, -15 }, { 49, -14 }, { 44, 3 },
	{ 45, 6 }, { 44, 34 }, { 33, 54 }, { 19, 82 },
	{ -3, 75 }, { -1, 23 }, { 1, 34 }, { 1, 43 },
	{ 0, 54 }, { -2, 55 }, { 0, 61 }, { 1, 64 },
	{ 0, 68 }, { -9, 92 },
	/* 436 -> 459 */
	{ -14, 106 }, { -13, 97 }, { -15, 90 }, { -12, 90 },
	{ -18, 88 }, { -10, 73 }, { -9, 79 }, { -14, 86 },
	{ -10, 73 }, { -10, 70 }, { -10, 69 }, { -5, 66 },
	{ -9, 64 }, { -5, 58 }, { 2, 59 }, { 21, -10 },
	{ 24, -11 }, { 28, -8 }, { 28, -1 }, { 29, 3 },
	{ 29, 9 }, { 35, 20 }, { 29, 36 }, { 14, 67 }
};

static const s32 h264_context_init[HANTRO_H264_CABAC_IDC_NUM][HANTRO_H264_CABAC_CV_NUM][2] = {
	/* cabac_init_idc == 0 */
	{
		/* 0 -> 10 */
		{ 20, -15 }, { 2, 54 }, { 3, 74 }, { 20, -15 },
		{ 2, 54 }, { 3, 74 }, { -28, 127 }, { -23, 104 },
		{ -6, 53 }, { -1, 54 }, { 7, 51 },
		/* 11 -> 23 */
		{ 23, 33 }, { 23, 2 }, { 21, 0 }, { 1, 9 },
		{ 0, 49 }, { -37, 118 }, { 5, 57 }, { -13, 78 },
		{ -11, 65 }, { 1, 62 }, { 12, 49 }, { -4, 73 },
		{ 17, 50 },
		/* 24 -> 39 */
		{ 18, 64 }, { 9, 43 }, { 29, 0 }, { 26, 67 },
		{ 16, 90 }, { 9, 104 }, { -46, 127 }, { -20, 104 },
		{ 1, 67 }, { -13, 78 }, { -11, 65 }, { 1, 62 },
		{ -6, 86 }, { -17, 95 }, { -6, 61 }, { 9, 45 },
		/* 40 -> 53 */
		{ -3, 69 }, { -6, 81 }, { -11, 96 }, { 6, 55 },
		{ 7, 67 }, { -5, 86 }, { 2, 88 }, { 0, 58 },
		{ -3, 76 }, { -10, 94 }, { 5, 54 }, { 4, 69 },
		{ -3, 81 }, { 0, 88 },
		/* 54 -> 59 */
		{ -7, 67 }, { -5, 74 }, { -4, 74 }, { -5, 80 },
		{ -7, 72 }, { 1, 58 },
		/* 60 -> 69 */
		{ 0, 41 }, { 0, 63 }, { 0, 63 }, { 0, 63 },
		{ -9, 83 }, { 4, 86 }, { 0, 97 }, { -7, 72 },
		{ 13, 41 }, { 3, 62 },
		/* 70 -> 87 */
		{ 0, 45 }, { -4, 78 }, { -3, 96 }, { -27, 126 },
		{ -28, 98 }, { -25, 101 }, { -23, 67 }, { -28, 82 },
		{ -20, 94 }, { -16, 83 }, { -22, 110 }, { -21, 91 },
		{ -18, 102 }, { -13, 93 }, { -29, 127 }, { -7, 92 },
		{ -5, 89 }, { -7, 96 }, { -13, 108 }, { -3, 46 },
		{ -1, 65 }, { -1, 57 }, { -9, 93 }, { -3, 74 },
		{ -9, 92 }, { -8, 87 }, { -23, 126 }, { 5, 54 },
		{ 6, 60 }, { 6, 59 }, { 6, 69 }, { -1, 48 },
		{ 0, 68 }, { -4, 69 }, { -8, 88 },
		/* 105 -> 165 */
		{ -2, 85 }, { -6, 78 }, { -1, 75 }, { -7, 77 },
		{ 2, 54 }, { 5, 50 }, { -3, 68 }, { 1, 50 },
		{ 6, 42 }, { -4, 81 }, { 1, 63 }, { -4, 70 },
		{ 0, 67 }, { 2, 57 }, { -2, 76 }, { 11, 35 },
		{ 4, 64 }, { 1, 61 }, { 11, 35 }, { 18, 25 },
		{ 12, 24 }, { 13, 29 }, { 13, 36 }, { -10, 93 },
		{ -7, 73 }, { -2, 73 }, { 13, 46 }, { 9, 49 },
		{ -7, 100 }, { 9, 53 }, { 2, 53 }, { 5, 53 },
		{ -2, 61 }, { 0, 56 }, { 0, 56 }, { -13, 63 },
		{ -5, 60 }, { -1, 62 }, { 4, 57 }, { -6, 69 },
		{ 4, 57 }, { 14, 39 }, { 4, 51 }, { 13, 68 },
		{ 3, 64 }, { 1, 61 }, { 9, 63 }, { 7, 50 },
		{ 16, 39 }, { 5, 44 }, { 4, 52 }, { 11, 48 },
		{ -5, 60 }, { -1, 59 }, { 0, 59 }, { 22, 33 },
		{ 5, 44 }, { 14, 43 }, { -1, 78 }, { 0, 60 },
		{ 9, 69 },
		/* 166 -> 226 */
		{ 11, 28 }, { 2, 40 }, { 3, 44 }, { 0, 49 },
		{ 0, 46 }, { 2, 44 }, { 2, 51 }, { 0, 47 },
		{ 4, 39 }, { 2, 62 }, { 6, 46 }, { 0, 54 },
		{ 3, 54 }, { 2, 58 }, { 4, 63 }, { 6, 51 },
		{ 6, 57 }, { 7, 53 }, { 6, 52 }, { 6, 55 },
		{ 11, 45 }, { 14, 36 }, { 8, 53 }, { -1, 82 },
		{ 7, 55 }, { -3, 78 }, { 15, 46 }, { 22, 31 },
		{ -1, 84 }, { 25, 7 }, { 30, -7 }, { 28, 3 },
		{ 28, 4 }, { 32, 0 }, { 34, -1 }, { 30, 6 },
		{ 30, 6 }, { 32, 9 }, { 31, 19 }, { 26, 27 },
		{ 26, 30 }, { 37, 20 }, { 28, 34 }, { 17, 70 },
		{ 1, 67 }, { 5, 59 }, { 9, 67 }, { 16, 30 },
		{ 18, 32 }, { 18, 35 }, { 22, 29 }, { 24, 31 },
		{ 23, 38 }, { 18, 43 }, { 20, 41 }, { 11, 63 },
		{ 9, 59 }, { 9, 64 }, { -1, 94 }, { -2, 89 },
		{ -9, 108 },
		/* 227 -> 275 */
		{ -6, 76 }, { -2, 44 }, { 0, 45 }, { 0, 52 },
		{ -3, 64 }, { -2, 59 }, { -4, 70 }, { -4, 75 },
		{ -8, 82 }, { -17, 102 }, { -9, 77 }, { 3, 24 },
		{ 0, 42 }, { 0, 48 }, { 0, 55 }, { -6, 59 },
		{ -7, 71 }, { -12, 83 }, { -11, 87 }, { -30, 119 },
		{ 1, 58 }, { -3, 29 }, { -1, 36 }, { 1, 38 },
		{ 2, 43 }, { -6, 55 }, { 0, 58 }, { 0, 64 },
		{ -3, 74 }, { -10, 90 }, { 0, 70 }, { -4, 29 },
		{ 5, 31 }, { 7, 42 }, { 1, 59 }, { -2, 58 },
		{ -3, 72 }, { -3, 81 }, { -11, 97 }, { 0, 58 },
		{ 8, 5 }, { 10, 14 }, { 14, 18 }, { 13, 27 },
		{ 2, 40 }, { 0, 58 }, { -3, 70 }, { -6, 79 },
		{ -8, 85 },
		/* 276 special case, bypass used */
		{ 0, 0 },
		/* 277 -> 337 */
		{ -13, 106 }, { -16, 106 }, { -10, 87 }, { -21, 114 },
		{ -18, 110 }, { -14, 98 }, { -22, 110 }, { -21, 106 },
		{ -18, 103 }, { -21, 107 }, { -23, 108 }, { -26, 112 },
		{ -10, 96 }, { -12, 95 }, { -5, 91 }, { -9, 93 },
		{ -22, 94 }, { -5, 86 }, { 9, 67 }, { -4, 80 },
		{ -10, 85 }, { -1, 70 }, { 7, 60 }, { 9, 58 },
		{ 5, 61 }, { 12, 50 }, { 15, 50 }, { 18, 49 },
		{ 17, 54 }, { 10, 41 }, { 7, 46 }, { -1, 51 },
		{ 7, 49 }, { 8, 52 }, { 9, 41 }, { 6, 47 },
		{ 2, 55 }, { 13, 41 }, { 10, 44 }, { 6, 50 },
		{ 5, 53 }, { 13, 49 }, { 4, 63 }, { 6, 64 },
		{ -2, 69 }, { -2, 59 }, { 6, 70 }, { 10, 44 },
		{ 9, 31 }, { 12, 43 }, { 3, 53 }, { 14, 34 },
		{ 10, 38 }, { -3, 52 }, { 13, 40 }, { 17, 32 },
		{ 7, 44 }, { 7, 38 }, { 13, 50 }, { 10, 57 },
		{ 26, 43 },
		/* 338 -> 398 */
		{ 14, 11 }, { 11, 14 }, { 9, 11 }, { 18, 11 },
		{ 21, 9 }, { 23, -2 }, { 32, -15 }, { 32, -15 },
		{ 34, -21 }, { 39, -23 }, { 42, -33 }, { 41, -31 },
		{ 46, -28 }, { 38, -12 }, { 21, 29 }, { 45, -24 },
		{ 53, -45 }, { 48, -26 }, { 65, -43 }, { 43, -19 },
		{ 39, -10 }, { 30, 9 }, { 18, 26 }, { 20, 27 },
		{ 0, 57 }, { -14, 82 }, { -5, 75 }, { -19, 97 },
		{ -35, 125 }, { 27, 0 }, { 28, 0 }, { 31, -4 },
		{ 27, 6 }, { 34, 8 }, { 30, 10 }, { 24, 22 },
		{ 33, 19 }, { 22, 32 }, { 26, 31 }, { 21, 41 },
		{ 26, 44 }, { 23, 47 }, { 16, 65 }, { 14, 71 },
		{ 8, 60 }, { 6, 63 }, { 17, 65 }, { 21, 24 },
		{ 23, 20 }, { 26, 23 }, { 27, 32 }, { 28, 23 },
		{ 28, 24 }, { 23, 40 }, { 24, 32 }, { 28, 29 },
		{ 23, 42 }, { 19, 57 }, { 22, 53 }, { 22, 61 },
		{ 11, 86 },
		/* 399 -> 435 */
		{ 12, 40 }, { 11, 51 }, { 14, 59 },
		{ -4, 79 }, { -7, 71 }, { -5, 69 }, { -9, 70 },
		{ -8, 66 }, { -10, 68 }, { -19, 73 }, { -12, 69 },
		{ -16, 70 }, { -15, 67 }, { -20, 62 }, { -19, 70 },
		{ -16, 66 }, { -22, 65 }, { -20, 63 }, { 9, -2 },
		{ 26, -9 }, { 33, -9 }, { 39, -7 }, { 41, -2 },
		{ 45, 3 }, { 49, 9 }, { 45, 27 }, { 36, 59 },
		{ -6, 66 }, { -7, 35 }, { -7, 42 }, { -8, 45 },
		{ -5, 48 }, { -12, 56 }, { -6, 60 }, { -5, 62 },
		{ -8, 66 }, { -8, 76 },
		/* 436 -> 459 */
		{ -5, 85 }, { -6, 81 }, { -10, 77 }, { -7, 81 },
		{ -17, 80 }, { -18, 73 }, { -4, 74 }, { -10, 83 },
		{ -9, 71 }, { -9, 67 }, { -1, 61 }, { -8, 66 },
		{ -14, 66 }, { 0, 59 }, { 2, 59 }, { 21, -13 },
		{ 33, -14 }, { 39, -7 }, { 46, -2 }, { 51, 2 },
		{ 60, 6 }, { 61, 17 }, { 55, 34 }, { 42, 62 },
	},
	/* cabac_init_idc == 1 */
	{
		/* 0 -> 10 */
		{ 20, -15 }, { 2, 54 }, { 3, 74 }, { 20, -15 },
		{ 2, 54 }, { 3, 74 }, { -28, 127 }, { -23, 104 },
		{ -6, 53 }, { -1, 54 }, { 7, 51 },
		/* 11 -> 23 */
		{ 22, 25 }, { 34, 0 }, { 16, 0 }, { -2, 9 },
		{ 4, 41 }, { -29, 118 }, { 2, 65 }, { -6, 71 },
		{ -13, 79 }, { 5, 52 }, { 9, 50 }, { -3, 70 },
		{ 10, 54 },
		/* 24 -> 39 */
		{ 26, 34 }, { 19, 22 }, { 40, 0 }, { 57, 2 },
		{ 41, 36 }, { 26, 69 }, { -45, 127 }, { -15, 101 },
		{ -4, 76 }, { -6, 71 }, { -13, 79 }, { 5, 52 },
		{ 6, 69 }, { -13, 90 }, { 0, 52 }, { 8, 43 },
		/* 40 -> 53 */
		{ -2, 69 }, { -5, 82 }, { -10, 96 }, { 2, 59 },
		{ 2, 75 }, { -3, 87 }, { -3, 100 }, { 1, 56 },
		{ -3, 74 }, { -6, 85 }, { 0, 59 }, { -3, 81 },
		{ -7, 86 }, { -5, 95 },
		/* 54 -> 59 */
		{ -1, 66 }, { -1, 77 }, { 1, 70 }, { -2, 86 },
		{ -5, 72 }, { 0, 61 },
		/* 60 -> 69 */
		{ 0, 41 }, { 0, 63 }, { 0, 63 }, { 0, 63 },
		{ -9, 83 }, { 4, 86 }, { 0, 97 }, { -7, 72 },
		{ 13, 41 }, { 3, 62 },
		/* 70 -> 104 */
		{ 13, 15 }, { 7, 51 }, { 2, 80 }, { -39, 127 },
		{ -18, 91 }, { -17, 96 }, { -26, 81 }, { -35, 98 },
		{ -24, 102 }, { -23, 97 }, { -27, 119 }, { -24, 99 },
		{ -21, 110 }, { -18, 102 }, { -36, 127 }, { 0, 80 },
		{ -5, 89 }, { -7, 94 }, { -4, 92 }, { 0, 39 },
		{ 0, 65 }, { -15, 84 }, { -35, 127 }, { -2, 73 },
		{ -12, 104 }, { -9, 91 }, { -31, 127 }, { 3, 55 },
		{ 7, 56 }, { 7, 55 }, { 8, 61 }, { -3, 53 },
		{ 0, 68 }, { -7, 74 }, { -9, 88 },
		/* 105 -> 165 */
		{ -13, 103 }, { -13, 91 }, { -9, 89 }, { -14, 92 },
		{ -8, 76 }, { -12, 87 }, { -23, 110 }, { -24, 105 },
		{ -10, 78 }, { -20, 112 }, { -17, 99 }, { -78, 127 },
		{ -70, 127 }, { -50, 127 }, { -46, 127 }, { -4, 66 },
		{ -5, 78 }, { -4, 71 }, { -8, 72 }, { 2, 59 },
		{ -1, 55 }, { -7, 70 }, { -6, 75 }, { -8, 89 },
		{ -34, 119 }, { -3, 75 }, { 32, 20 }, { 30, 22 },
		{ -44, 127 }, { 0, 54 }, { -5, 61 }, { 0, 58 },
		{ -1, 60 }, { -3, 61 }, { -8, 67 }, { -25, 84 },
		{ -14, 74 }, { -5, 65 }, { 5, 52 }, { 2, 57 },
		{ 0, 61 }, { -9, 69 }, { -11, 70 }, { 18, 55 },
		{ -4, 71 }, { 0, 58 }, { 7, 61 }, { 9, 41 },
		{ 18, 25 }, { 9, 32 }, { 5, 43 }, { 9, 47 },
		{ 0, 44 }, { 0, 51 }, { 2, 46 }, { 19, 38 },
		{ -4, 66 }, { 15, 38 }, { 12, 42 }, { 9, 34 },
		{ 0, 89 },
		/* 166 -> 226 */
		{ 4, 45 }, { 10, 28 }, { 10, 31 }, { 33, -11 },
		{ 52, -43 }, { 18, 15 }, { 28, 0 }, { 35, -22 },
		{ 38, -25 }, { 34, 0 }, { 39, -18 }, { 32, -12 },
		{ 102, -94 }, { 0, 0 }, { 56, -15 }, { 33, -4 },
		{ 29, 10 }, { 37, -5 }, { 51, -29 }, { 39, -9 },
		{ 52, -34 }, { 69, -58 }, { 67, -63 }, { 44, -5 },
		{ 32, 7 }, { 55, -29 }, { 32, 1 }, { 0, 0 },
		{ 27, 36 }, { 33, -25 }, { 34, -30 }, { 36, -28 },
		{ 38, -28 }, { 38, -27 }, { 34, -18 }, { 35, -16 },
		{ 34, -14 }, { 32, -8 }, { 37, -6 }, { 35, 0 },
		{ 30, 10 }, { 28, 18 }, { 26, 25 }, { 29, 41 },
		{ 0, 75 }, { 2, 72 }, { 8, 77 }, { 14, 35 },
		{ 18, 31 }, { 17, 35 }, { 21, 30 }, { 17, 45 },
		{ 20, 42 }, { 18, 45 }, { 27, 26 }, { 16, 54 },
		{ 7, 66 }, { 16, 56 }, { 11, 73 }, { 10, 67 },
		{ -10, 116 },
		/* 227 -> 275 */
		{ -23, 112 }, { -15, 71 }, { -7, 61 }, { 0, 53 },
		{ -5, 66 }, { -11, 77 }, { -9, 80 }, { -9, 84 },
		{ -10, 87 }, { -34, 127 }, { -21, 101 }, { -3, 39 },
		{ -5, 53 }, { -7, 61 }, { -11, 75 }, { -15, 77 },
		{ -17, 91 }, { -25, 107 }, { -25, 111 }, { -28, 122 },
		{ -11, 76 }, { -10, 44 }, { -10, 52 }, { -10, 57 },
		{ -9, 58 }, { -16, 72 }, { -7, 69 }, { -4, 69 },
		{ -5, 74 }, { -9, 86 }, { 2, 66 }, { -9, 34 },
		{ 1, 32 }, { 11, 31 }, { 5, 52 }, { -2, 55 },
		{ -2, 67 }, { 0, 73 }, { -8, 89 }, { 3, 52 },
		{ 7, 4 }, { 10, 8 }, { 17, 8 }, { 16, 19 },
		{ 3, 37 }, { -1, 61 }, { -5, 73 }, { -1, 70 },
		{ -4, 78 },
		/* 276 special case, bypass used */
		{ 0, 0 },
		/* 277 -> 337 */
		{ -21, 126 }, { -23, 124 }, { -20, 110 }, { -26, 126 },
		{ -25, 124 }, { -17, 105 }, { -27, 121 }, { -27, 117 },
		{ -17, 102 }, { -26, 117 }, { -27, 116 }, { -33, 122 },
		{ -10, 95 }, { -14, 100 }, { -8, 95 }, { -17, 111 },
		{ -28, 114 }, { -6, 89 }, { -2, 80 }, { -4, 82 },
		{ -9, 85 }, { -8, 81 }, { -1, 72 }, { 5, 64 },
		{ 1, 67 }, { 9, 56 }, { 0, 69 }, { 1, 69 },
		{ 7, 69 }, { -7, 69 }, { -6, 67 }, { -16, 77 },
		{ -2, 64 }, { 2, 61 }, { -6, 67 }, { -3, 64 },
		{ 2, 57 }, { -3, 65 }, { -3, 66 }, { 0, 62 },
		{ 9, 51 }, { -1, 66 }, { -2, 71 }, { -2, 75 },
		{ -1, 70 }, { -9, 72 }, { 14, 60 }, { 16, 37 },
		{ 0, 47 }, { 18, 35 }, { 11, 37 }, { 12, 41 },
		{ 10, 41 }, { 2, 48 }, { 12, 41 }, { 13, 41 },
		{ 0, 59 }, { 3, 50 }, { 19, 40 }, { 3, 66 },
		{ 18, 50 },
		/* 338 -> 398 */
		{ 19, -6 }, { 18, -6 }, { 14, 0 }, { 26, -12 },
		{ 31, -16 }, { 33, -25 }, { 33, -22 }, { 37, -28 },
		{ 39, -30 }, { 42, -30 }, { 47, -42 }, { 45, -36 },
		{ 49, -34 }, { 41, -17 }, { 32, 9 }, { 69, -71 },
		{ 63, -63 }, { 66, -64 }, { 77, -74 }, { 54, -39 },
		{ 52, -35 }, { 41, -10 }, { 36, 0 }, { 40, -1 },
		{ 30, 14 }, { 28, 26 }, { 23, 37 }, { 12, 55 },
		{ 11, 65 }, { 37, -33 }, { 39, -36 }, { 40, -37 },
		{ 38, -30 }, { 46, -33 }, { 42, -30 }, { 40, -24 },
		{ 49, -29 }, { 38, -12 }, { 40, -10 }, { 38, -3 },
		{ 46, -5 }, { 31, 20 }, { 29, 30 }, { 25, 44 },
		{ 12, 48 }, { 11, 49 }, { 26, 45 }, { 22, 22 },
		{ 23, 22 }, { 27, 21 }, { 33, 20 }, { 26, 28 },
		{ 30, 24 }, { 27, 34 }, { 18, 42 }, { 25, 39 },
		{ 18, 50 }, { 12, 70 }, { 21, 54 }, { 14, 71 },
		{ 11, 83 },
		/* 399 -> 435 */
		{ 25, 32 }, { 21, 49 }, { 21, 54 },
		{ -5, 85 }, { -6, 81 }, { -10, 77 }, { -7, 81 },
		{ -17, 80 }, { -18, 73 }, { -4, 74 }, { -10, 83 },
		{ -9, 71 }, { -9, 67 }, { -1, 61 }, { -8, 66 },
		{ -14, 66 }, { 0, 59 }, { 2, 59 }, { 17, -10 },
		{ 32, -13 }, { 42, -9 }, { 49, -5 }, { 53, 0 },
		{ 64, 3 }, { 68, 10 }, { 66, 27 }, { 47, 57 },
		{ -5, 71 }, { 0, 24 }, { -1, 36 }, { -2, 42 },
		{ -2, 52 }, { -9, 57 }, { -6, 63 }, { -4, 65 },
		{ -4, 67 }, { -7, 82 },
		/* 436 -> 459 */
		{ -3, 81 }, { -3, 76 }, { -7, 72 }, { -6, 78 },
		{ -12, 72 }, { -14, 68 }, { -3, 70 }, { -6, 76 },
		{ -5, 66 }, { -5, 62 }, { 0, 57 }, { -4, 61 },
		{ -9, 60 }, { 1, 54 }, { 2, 58 }, { 17, -10 },
		{ 32, -13 }, { 42, -9 }, { 49, -5 }, { 53, 0 },
		{ 64, 3 }, { 68, 10 }, { 66, 27 }, { 47, 57 },
	},
	/* cabac_init_idc == 2 */
	{
		/* 0 -> 10 */
		{ 20, -15 }, { 2, 54 }, { 3, 74 }, { 20, -15 },
		{ 2, 54 }, { 3, 74 }, { -28, 127 }, { -23, 104 },
		{ -6, 53 }, { -1, 54 }, { 7, 51 },
		/* 11 -> 23 */
		{ 29, 16 }, { 25, 0 }, { 14, 0 }, { -10, 51 },
		{ -3, 62 }, { -27, 99 }, { 26, 16 }, { -4, 85 },
		{ -24, 102 }, { 5, 57 }, { 6, 57 }, { -17, 73 },
		{ 14, 57 },
		/* 24 -> 39 */
		{ 20, 40 }, { 20, 10 }, { 29, 0 }, { 54, 0 },
		{ 37, 42 }, { 12, 97 }, { -32, 127 }, { -22, 117 },
		{ -2, 74 }, { -4, 85 }, { -24, 102 }, { 5, 57 },
		{ -6, 93 }, { -14, 88 }, { -6, 44 }, { 4, 55 },
		/* 40 -> 53 */
		{ -11, 89 }, { -15, 103 }, { -21, 116 }, { 19, 57 },
		{ 20, 58 }, { 4, 84 }, { 6, 96 }, { 1, 63 },
		{ -5, 85 }, { -13, 106 }, { 5, 63 }, { 6, 75 },
		{ -3, 90 }, { -1, 101 },
		/* 54 -> 59 */
		{ 3, 55 }, { -4, 79 }, { -2, 75 }, { -12, 97 },
		{ -7, 50 }, { 1, 60 },
		/* 60 -> 69 */
		{ 0, 41 }, { 0, 63 }, { 0, 63 }, { 0, 63 },
		{ -9, 83 }, { 4, 86 }, { 0, 97 }, { -7, 72 },
		{ 13, 41 }, { 3, 62 },
		/* 70 -> 104 */
		{ 7, 34 }, { -9, 88 }, { -20, 127 }, { -36, 127 },
		{ -17, 91 }, { -14, 95 }, { -25, 84 }, { -25, 86 },
		{ -12, 89 }, { -17, 91 }, { -31, 127 }, { -14, 76 },
		{ -18, 103 }, { -13, 90 }, { -37, 127 }, { 11, 80 },
		{ 5, 76 }, { 2, 84 }, { 5, 78 }, { -6, 55 },
		{ 4, 61 }, { -14, 83 }, { -37, 127 }, { -5, 79 },
		{ -11, 104 }, { -11, 91 }, { -30, 127 }, { 0, 65 },
		{ -2, 79 }, { 0, 72 }, { -4, 92 }, { -6, 56 },
		{ 3, 68 }, { -8, 71 }, { -13, 98 },
		/* 105 -> 165 */
		{ -4, 86 }, { -12, 88 }, { -5, 82 }, { -3, 72 },
		{ -4, 67 }, { -8, 72 }, { -16, 89 }, { -9, 69 },
		{ -1, 59 }, { 5, 66 }, { 4, 57 }, { -4, 71 },
		{ -2, 71 }, { 2, 58 }, { -1, 74 }, { -4, 44 },
		{ -1, 69 }, { 0, 62 }, { -7, 51 }, { -4, 47 },
		{ -6, 42 }, { -3, 41 }, { -6, 53 }, { 8, 76 },
		{ -9, 78 }, { -11, 83 }, { 9, 52 }, { 0, 67 },
		{ -5, 90 }, { 1, 67 }, { -15, 72 }, { -5, 75 },
		{ -8, 80 }, { -21, 83 }, { -21, 64 }, { -13, 31 },
		{ -25, 64 }, { -29, 94 }, { 9, 75 }, { 17, 63 },
		{ -8, 74 }, { -5, 35 }, { -2, 27 }, { 13, 91 },
		{ 3, 65 }, { -7, 69 }, { 8, 77 }, { -10, 66 },
		{ 3, 62 }, { -3, 68 }, { -20, 81 }, { 0, 30 },
		{ 1, 7 }, { -3, 23 }, { -21, 74 }, { 16, 66 },
		{ -23, 124 }, { 17, 37 }, { 44, -18 }, { 50, -34 },
		{ -22, 127 },
		/* 166 -> 226 */
		{ 4, 39 }, { 0, 42 }, { 7, 34 }, { 11, 29 },
		{ 8, 31 }, { 6, 37 }, { 7, 42 }, { 3, 40 },
		{ 8, 33 }, { 13, 43 }, { 13, 36 }, { 4, 47 },
		{ 3, 55 }, { 2, 58 }, { 6, 60 }, { 8, 44 },
		{ 11, 44 }, { 14, 42 }, { 7, 48 }, { 4, 56 },
		{ 4, 52 }, { 13, 37 }, { 9, 49 }, { 19, 58 },
		{ 10, 48 }, { 12, 45 }, { 0, 69 }, { 20, 33 },
		{ 8, 63 }, { 35, -18 }, { 33, -25 }, { 28, -3 },
		{ 24, 10 }, { 27, 0 }, { 34, -14 }, { 52, -44 },
		{ 39, -24 }, { 19, 17 }, { 31, 25 }, { 36, 29 },
		{ 24, 33 }, { 34, 15 }, { 30, 20 }, { 22, 73 },
		{ 20, 34 }, { 19, 31 }, { 27, 44 }, { 19, 16 },
		{ 15, 36 }, { 15, 36 }, { 21, 28 }, { 25, 21 },
		{ 30, 20 }, { 31, 12 }, { 27, 16 }, { 24, 42 },
		{ 0, 93 }, { 14, 56 }, { 15, 57 }, { 26, 38 },
		{ -24, 127 },
		/* 227 -> 275 */
		{ -24, 115 }, { -22, 82 }, { -9, 62 }, { 0, 53 },
		{ 0, 59 }, { -14, 85 }, { -13, 89 }, { -13, 94 },
		{ -11, 92 }, { -29, 127 }, { -21, 100 }, { -14, 57 },
		{ -12, 67 }, { -11, 71 }, { -10, 77 }, { -21, 85 },
		{ -16, 88 }, { -23, 104 }, { -15, 98 }, { -37, 127 },
		{ -10, 82 }, { -8, 48 }, { -8, 61 }, { -8, 66 },
		{ -7, 70 }, { -14, 75 }, { -10, 79 }, { -9, 83 },
		{ -12, 92 }, { -18, 108 }, { -4, 79 }, { -22, 69 },
		{ -16, 75 }, { -2, 58 }, { 1, 58 }, { -13, 78 },
		{ -9, 83 }, { -4, 81 }, { -13, 99 }, { -13, 81 },
		{ -6, 38 }, { -13, 62 }, { -6, 58 }, { -2, 59 },
		{ -16, 73 }, { -10, 76 }, { -13, 86 }, { -9, 83 },
		{ -10, 87 },
		/* 276 special case, bypass used */
		{ 0, 0 },
		/* 277 -> 337 */
		{ -22, 127 }, { -25, 127 }, { -25, 120 }, { -27, 127 },
		{ -19, 114 }, { -23, 117 }, { -25, 118 }, { -26, 117 },
		{ -24, 113 }, { -28, 118 }, { -31, 120 }, { -37, 124 },
		{ -10, 94 }, { -15, 102 }, { -10, 99 }, { -13, 106 },
		{ -50, 127 }, { -5, 92 }, { 17, 57 }, { -5, 86 },
		{ -13, 94 }, { -12, 91 }, { -2, 77 }, { 0, 71 },
		{ -1, 73 }, { 4, 64 }, { -7, 81 }, { 5, 64 },
		{ 15, 57 }, { 1, 67 }, { 0, 68 }, { -10, 67 },
		{ 1, 68 }, { 0, 77 }, { 2, 64 }, { 0, 68 },
		{ -5, 78 }, { 7, 55 }, { 5, 59 }, { 2, 65 },
		{ 14, 54 }, { 15, 44 }, { 5, 60 }, { 2, 70 },
		{ -2, 76 }, { -18, 86 }, { 12, 70 }, { 5, 64 },
		{ -12, 70 }, { 11, 55 }, { 5, 56 }, { 0, 69 },
		{ 2, 65 }, { -6, 74 }, { 5, 54 }, { 7, 54 },
		{ -6, 76 }, { -11, 82 }, { -2, 77 }, { -2, 77 },
		{ 25, 42 },
		/* 338 -> 398 */
		{ 17, -13 }, { 16, -9 }, { 17, -12 }, { 27, -21 },
		{ 37, -30 }, { 41, -40 }, { 42, -41 }, { 48, -47 },
		{ 39, -32 }, { 46, -40 }, { 52, -51 }, { 46, -41 },
		{ 52, -39 }, { 43, -19 }, { 32, 11 }, { 61, -55 },
		{ 56, -46 }, { 62, -50 }, { 81, -67 }, { 45, -20 },
		{ 35, -2 }, { 28, 15 }, { 34, 1 }, { 39, 1 },
		{ 30, 17 }, { 20, 38 }, { 18, 45 }, { 15, 54 },
		{ 0, 79 }, { 36, -16 }, { 37, -14 }, { 37, -17 },
		{ 32, 1 }, { 34, 15 }, { 29, 15 }, { 24, 25 },
		{ 34, 22 }, { 31, 16 }, { 35, 18 }, { 31, 28 },
		{ 33, 41 }, { 36, 28 }, { 27, 47 }, { 21, 62 },
		{ 18, 31 }, { 19, 26 }, { 36, 24 }, { 24, 23 },
		{ 27, 16 }, { 24, 30 }, { 31, 29 }, { 22, 41 },
		{ 22, 42 }, { 16, 60 }, { 15, 52 }, { 14, 60 },
		{ 3, 78 }, { -16, 123 }, { 21, 53 }, { 22, 56 },
		{ 25, 61 },
		/* 399 -> 435 */
		{ 21, 33 }, { 19, 50 }, { 17, 61 },
		{ -3, 78 }, { -8, 74 }, { -9, 72 }, { -10, 72 },
		{ -18, 75 }, { -12, 71 }, { -11, 63 }, { -5, 70 },
		{ -17, 75 }, { -14, 72 }, { -16, 67 }, { -8, 53 },
		{ -14, 59 }, { -9, 52 }, { -11, 68 }, { 9, -2 },
		{ 30, -10 }, { 31, -4 }, { 33, -1 }, { 33, 7 },
		{ 31, 12 }, { 37, 23 }, { 31, 38 }, { 20, 64 },
		{ -9, 71 }, { -7, 37 }, { -8, 44 }, { -11, 49 },
		{ -10, 56 }, { -12, 59 }, { -8, 63 }, { -9, 67 },
		{ -6, 68 }, { -10, 79 },
		/* 436 -> 459 */
		{ -3, 78 }, { -8, 74 }, { -9, 72 }, { -10, 72 },
		{ -18, 75 }, { -12, 71 }, { -11, 63 }, { -5, 70 },
		{ -17, 75 }, { -14, 72 }, { -16, 67 }, { -8, 53 },
		{ -14, 59 }, { -9, 52 }, { -11, 68 }, { 9, -2 },
		{ 30, -10 }, { 31, -4 }, { 33, -1 }, { 33, 7 },
		{ 31, 12 }, { 37, 23 }, { 31, 38 }, { 20, 64 },
	}
};

static void
assemble_scaling_list(struct hantro_ctx *ctx)
{
	const struct hantro_h264_dec_ctrls *ctrls = &ctx->h264_dec.ctrls;
	const struct v4l2_ctrl_h264_scaling_matrix *scaling = ctrls->scaling;
	const struct v4l2_ctrl_h264_pps *pps = ctrls->pps;
	const size_t num_list_4x4 = ARRAY_SIZE(scaling->scaling_list_4x4);
	const size_t list_len_4x4 = ARRAY_SIZE(scaling->scaling_list_4x4[0]);
	const size_t list_len_8x8 = ARRAY_SIZE(scaling->scaling_list_8x8[0]);
	struct hantro_h264_dec_priv_tbl *tbl = ctx->h264_dec.priv.cpu;
	u32 *dst = (u32 *)tbl->scaling_list;
	const u32 *src;
	int i, j;

	if (!(pps->flags & V4L2_H264_PPS_FLAG_SCALING_MATRIX_PRESENT))
		return;

	for (i = 0; i < num_list_4x4; i++) {
		src = (u32 *)&scaling->scaling_list_4x4[i];
		for (j = 0; j < list_len_4x4 / 4; j++)
			*dst++ = swab32(src[j]);
	}

	/* Only Intra/Inter Y lists */
	for (i = 0; i < 2; i++) {
		src = (u32 *)&scaling->scaling_list_8x8[i];
		for (j = 0; j < list_len_8x8 / 4; j++)
			*dst++ = swab32(src[j]);
	}
}

static void prepare_table(struct hantro_ctx *ctx)
{
	const struct hantro_h264_dec_ctrls *ctrls = &ctx->h264_dec.ctrls;
	const struct v4l2_ctrl_h264_decode_params *dec_param = ctrls->decode;
	const struct v4l2_ctrl_h264_sps *sps = ctrls->sps;
	struct hantro_h264_dec_priv_tbl *tbl = ctx->h264_dec.priv.cpu;
	const struct v4l2_h264_dpb_entry *dpb = ctx->h264_dec.dpb;
	u32 dpb_longterm = 0;
	u32 dpb_valid = 0;
	int i;

	for (i = 0; i < HANTRO_H264_DPB_SIZE; ++i) {
		tbl->poc[i * 2] = dpb[i].top_field_order_cnt;
		tbl->poc[i * 2 + 1] = dpb[i].bottom_field_order_cnt;

		if (!(dpb[i].flags & V4L2_H264_DPB_ENTRY_FLAG_VALID))
			continue;

		/*
		 * Set up bit maps of valid and long term DPBs.
		 * NOTE: The bits are reversed, i.e. MSb is DPB 0. For frame
		 * decoding, bit 31 to 15 are used, while for field decoding,
		 * all bits are used, with bit 31 being a top field, 30 a bottom
		 * field and so on.
		 */
		if (dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_FIELD_PIC) {
			if (dpb[i].fields & V4L2_H264_TOP_FIELD_REF)
				dpb_valid |= REF_BIT(i * 2);

			if (dpb[i].fields & V4L2_H264_BOTTOM_FIELD_REF)
				dpb_valid |= REF_BIT(i * 2 + 1);

			if (dpb[i].flags & V4L2_H264_DPB_ENTRY_FLAG_LONG_TERM) {
				dpb_longterm |= REF_BIT(i * 2);
				dpb_longterm |= REF_BIT(i * 2 + 1);
			}
		} else {
			dpb_valid |= REF_BIT(i);

			if (dpb[i].flags & V4L2_H264_DPB_ENTRY_FLAG_LONG_TERM)
				dpb_longterm |= REF_BIT(i);
		}
	}
	ctx->h264_dec.dpb_valid = dpb_valid;
	ctx->h264_dec.dpb_longterm = dpb_longterm;

	if ((dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_FIELD_PIC) ||
	    !(sps->flags & V4L2_H264_SPS_FLAG_MB_ADAPTIVE_FRAME_FIELD)) {
		tbl->poc[32] = ctx->h264_dec.cur_poc;
		tbl->poc[33] = 0;
	} else {
		tbl->poc[32] = dec_param->top_field_order_cnt;
		tbl->poc[33] = dec_param->bottom_field_order_cnt;
	}

	assemble_scaling_list(ctx);
}

static bool dpb_entry_match(const struct v4l2_h264_dpb_entry *a,
			    const struct v4l2_h264_dpb_entry *b)
{
	return a->reference_ts == b->reference_ts;
}

static void update_dpb(struct hantro_ctx *ctx)
{
	const struct v4l2_ctrl_h264_decode_params *dec_param;
	DECLARE_BITMAP(new, ARRAY_SIZE(dec_param->dpb)) = { 0, };
	DECLARE_BITMAP(used, ARRAY_SIZE(dec_param->dpb)) = { 0, };
	unsigned int i, j;

	dec_param = ctx->h264_dec.ctrls.decode;

	/* Disable all entries by default. */
	for (i = 0; i < ARRAY_SIZE(ctx->h264_dec.dpb); i++)
		ctx->h264_dec.dpb[i].flags = 0;

	/* Try to match new DPB entries with existing ones by their POCs. */
	for (i = 0; i < ARRAY_SIZE(dec_param->dpb); i++) {
		const struct v4l2_h264_dpb_entry *ndpb = &dec_param->dpb[i];

		if (!(ndpb->flags & V4L2_H264_DPB_ENTRY_FLAG_VALID))
			continue;

		/*
		 * To cut off some comparisons, iterate only on target DPB
		 * entries which are not used yet.
		 */
		for_each_clear_bit(j, used, ARRAY_SIZE(ctx->h264_dec.dpb)) {
			struct v4l2_h264_dpb_entry *cdpb;

			cdpb = &ctx->h264_dec.dpb[j];
			if (!dpb_entry_match(cdpb, ndpb))
				continue;

			*cdpb = *ndpb;
			set_bit(j, used);
			break;
		}

		if (j == ARRAY_SIZE(ctx->h264_dec.dpb))
			set_bit(i, new);
	}

	/* For entries that could not be matched, use remaining free slots. */
	for_each_set_bit(i, new, ARRAY_SIZE(dec_param->dpb)) {
		const struct v4l2_h264_dpb_entry *ndpb = &dec_param->dpb[i];
		struct v4l2_h264_dpb_entry *cdpb;

		/*
		 * Both arrays are of the same sizes, so there is no way
		 * we can end up with no space in target array, unless
		 * something is buggy.
		 */
		j = find_first_zero_bit(used, ARRAY_SIZE(ctx->h264_dec.dpb));
		if (WARN_ON(j >= ARRAY_SIZE(ctx->h264_dec.dpb)))
			return;

		cdpb = &ctx->h264_dec.dpb[j];
		*cdpb = *ndpb;
		set_bit(j, used);
	}
}

dma_addr_t hantro_h264_get_ref_buf(struct hantro_ctx *ctx,
				   unsigned int dpb_idx)
{
	struct v4l2_h264_dpb_entry *dpb = ctx->h264_dec.dpb;
	dma_addr_t dma_addr = 0;
	s32 cur_poc = ctx->h264_dec.cur_poc;
	u32 flags;

	if (dpb[dpb_idx].flags & V4L2_H264_DPB_ENTRY_FLAG_ACTIVE)
		dma_addr = hantro_get_ref(ctx, dpb[dpb_idx].reference_ts);

	if (!dma_addr) {
		struct vb2_v4l2_buffer *dst_buf;
		struct vb2_buffer *buf;

		/*
		 * If a DPB entry is unused or invalid, address of current
		 * destination buffer is returned.
		 */
		dst_buf = hantro_get_dst_buf(ctx);
		buf = &dst_buf->vb2_buf;
		dma_addr = hantro_get_dec_buf_addr(ctx, buf);
	}

	flags = dpb[dpb_idx].flags & V4L2_H264_DPB_ENTRY_FLAG_FIELD ? 0x2 : 0;
	flags |= abs(dpb[dpb_idx].top_field_order_cnt - cur_poc) <
		 abs(dpb[dpb_idx].bottom_field_order_cnt - cur_poc) ?
		 0x1 : 0;

	return dma_addr | flags;
}

u16 hantro_h264_get_ref_nbr(struct hantro_ctx *ctx, unsigned int dpb_idx)
{
	const struct v4l2_h264_dpb_entry *dpb = &ctx->h264_dec.dpb[dpb_idx];

	if (!(dpb->flags & V4L2_H264_DPB_ENTRY_FLAG_ACTIVE))
		return 0;
	return dpb->frame_num;
}

/*
 * Removes all references with the same parity as the current picture from the
 * reference list. The remaining list will have references with the opposite
 * parity. This is effectively a deduplication of references since each buffer
 * stores two fields. For this reason, each buffer is found twice in the
 * reference list.
 *
 * This technique has been chosen through trial and error. This simple approach
 * resulted in the highest conformance score. Note that this method may suffer
 * worse quality in the case an opposite reference frame has been lost. If this
 * becomes a problem in the future, it should be possible to add a preprocessing
 * to identify un-paired fields and avoid removing them.
 */
static void deduplicate_reflist(struct v4l2_h264_reflist_builder *b,
				struct v4l2_h264_reference *reflist)
{
	int write_idx = 0;
	int i;

	if (b->cur_pic_fields == V4L2_H264_FRAME_REF) {
		write_idx = b->num_valid;
		goto done;
	}

	for (i = 0; i < b->num_valid; i++) {
		if (!(b->cur_pic_fields == reflist[i].fields)) {
			reflist[write_idx++] = reflist[i];
			continue;
		}
	}

done:
	/* Should not happen unless we have a bug in the reflist builder. */
	if (WARN_ON(write_idx > 16))
		write_idx = 16;

	/* Clear the remaining, some streams fails otherwise */
	for (; write_idx < 16; write_idx++)
		reflist[write_idx].index = 15;
}

int hantro_h264_dec_prepare_run(struct hantro_ctx *ctx)
{
	struct hantro_h264_dec_hw_ctx *h264_ctx = &ctx->h264_dec;
	struct hantro_h264_dec_ctrls *ctrls = &h264_ctx->ctrls;
	struct v4l2_h264_reflist_builder reflist_builder;

	hantro_start_prepare_run(ctx);

	ctrls->scaling =
		hantro_get_ctrl(ctx, V4L2_CID_STATELESS_H264_SCALING_MATRIX);
	if (WARN_ON(!ctrls->scaling))
		return -EINVAL;

	ctrls->decode =
		hantro_get_ctrl(ctx, V4L2_CID_STATELESS_H264_DECODE_PARAMS);
	if (WARN_ON(!ctrls->decode))
		return -EINVAL;

	ctrls->sps =
		hantro_get_ctrl(ctx, V4L2_CID_STATELESS_H264_SPS);
	if (WARN_ON(!ctrls->sps))
		return -EINVAL;

	ctrls->pps =
		hantro_get_ctrl(ctx, V4L2_CID_STATELESS_H264_PPS);
	if (WARN_ON(!ctrls->pps))
		return -EINVAL;

	/* Update the DPB with new refs. */
	update_dpb(ctx);

	/* Build the P/B{0,1} ref lists. */
	v4l2_h264_init_reflist_builder(&reflist_builder, ctrls->decode,
				       ctrls->sps, ctx->h264_dec.dpb);
	h264_ctx->cur_poc = reflist_builder.cur_pic_order_count;

	/* Prepare data in memory. */
	prepare_table(ctx);

	v4l2_h264_build_p_ref_list(&reflist_builder, h264_ctx->reflists.p);
	v4l2_h264_build_b_ref_lists(&reflist_builder, h264_ctx->reflists.b0,
				    h264_ctx->reflists.b1);

	/*
	 * Reduce ref lists to at most 16 entries, Hantro hardware will deduce
	 * the actual picture lists in field through the dpb_valid,
	 * dpb_longterm bitmap along with the current frame parity.
	 */
	if (reflist_builder.cur_pic_fields != V4L2_H264_FRAME_REF) {
		deduplicate_reflist(&reflist_builder, h264_ctx->reflists.p);
		deduplicate_reflist(&reflist_builder, h264_ctx->reflists.b0);
		deduplicate_reflist(&reflist_builder, h264_ctx->reflists.b1);
	}

	return 0;
}

void hantro_h264_dec_exit(struct hantro_ctx *ctx)
{
	struct hantro_dev *vpu = ctx->dev;
	struct hantro_h264_dec_hw_ctx *h264_dec = &ctx->h264_dec;
	struct hantro_aux_buf *priv = &h264_dec->priv;

	dma_free_coherent(vpu->dev, priv->size, priv->cpu, priv->dma);
}

int hantro_h264_dec_init(struct hantro_ctx *ctx)
{
	struct hantro_dev *vpu = ctx->dev;
	struct hantro_h264_dec_hw_ctx *h264_dec = &ctx->h264_dec;
	struct hantro_aux_buf *priv = &h264_dec->priv;
	struct hantro_h264_dec_priv_tbl *tbl;

	priv->cpu = dma_alloc_coherent(vpu->dev, sizeof(*tbl), &priv->dma,
				       GFP_KERNEL);
	if (!priv->cpu)
		return -ENOMEM;

	priv->size = sizeof(*tbl);
	tbl = priv->cpu;
	memcpy(tbl->cabac_table, h264_cabac_table, sizeof(tbl->cabac_table));

	return 0;
}

void hantro_h264_enc_exit(struct hantro_ctx *ctx)
{
	struct hantro_dev *vpu = ctx->dev;
	int i;

	dma_free_coherent(vpu->dev, ctx->h264_enc.segment_map.size,
			  ctx->h264_enc.segment_map.cpu,
			  ctx->h264_enc.segment_map.dma);

	dma_free_coherent(vpu->dev, ctx->h264_enc.mv_buf.size,
			  ctx->h264_enc.mv_buf.cpu,
			  ctx->h264_enc.mv_buf.dma);

	i = HANTRO_H264_CABAC_IDC_NUM;
	while (--i >= 0)
		dma_free_coherent(vpu->dev, ctx->h264_enc.cabac_ctx[i].size,
				  ctx->h264_enc.cabac_ctx[i].cpu,
				  ctx->h264_enc.cabac_ctx[i].dma);

	dma_free_coherent(vpu->dev, ctx->h264_enc.nal_table.size,
			  ctx->h264_enc.nal_table.cpu,
			  ctx->h264_enc.nal_table.dma);

	i = HANTRO_H264_NUM_INTERNAL_FRAMES;
	while (--i >= 0)
		dma_free_coherent(vpu->dev, ctx->h264_enc.chroma_internal[i].size,
				  ctx->h264_enc.chroma_internal[i].cpu,
				  ctx->h264_enc.chroma_internal[i].dma);
	i = HANTRO_H264_NUM_INTERNAL_FRAMES;
	while (--i >= 0)
		dma_free_coherent(vpu->dev, ctx->h264_enc.luma_internal[i].size,
				  ctx->h264_enc.luma_internal[i].cpu,
				  ctx->h264_enc.luma_internal[i].dma);
}

#define LUMA_MB_BYTES_W 16
#define LUMA_MB_BYTES_H 16
#define LUMA_MB_BYTES (LUMA_MB_BYTES_W * LUMA_MB_BYTES_H)
#define CHROMA_MB_BYTES_W 8
#define CHROMA_MB_BYTES_H 8
#define CHROMA_MB_BYTES (CHROMA_MB_BYTES_W * CHROMA_MB_BYTES_H)
#define N_CHROMA_PLANES 2
#define NAL_ENTRY_BYTES 4
#define N_QPS 52
#define CABAC_CTX_TABLE_BYTES 464
#define MB_MV_BYTES 56
#define MB_SEGMENTATION_BITS 4

static void buffer_cpu_to_be64(u64 *buf, u32 size)
{
	u32 i;

	for (i = 0; i < size; ++i)
		buf[i] = cpu_to_be64(buf[i]);
}

static void h264_enc_init_cabac_table(struct hantro_ctx *ctx)
{
	u8 *table;
	const s32(*context)[HANTRO_H264_CABAC_CV_NUM][2];
	s32 i, j, k, qp;

	for (k = 0; k < HANTRO_H264_CABAC_IDC_NUM; k++) {
		table = (u8 *)ctx->h264_enc.cabac_ctx[k].cpu;

		for (qp = 0; qp < N_QPS; qp++) { /* All QP values */
			for (j = 0; j < 2; j++) { /* Intra/Inter */
				context = (j == 0) ?
					&h264_context_init_intra :
					&h264_context_init[k];
				for (i = 0; i < HANTRO_H264_CABAC_CV_NUM; i++) {
					s32 m = (s32)(*context)[i][0];
					s32 n = (s32)(*context)[i][1];
					s32 pre_ctx_st = clamp(((m * qp) >> 4) + n, 1, 126);
					int idx = qp * 464 * 2 + j * 464 + i;

					if (pre_ctx_st <= 63)
						table[idx] = (u8)((63 - pre_ctx_st) << 1);
					else
						table[idx] = (u8)(((pre_ctx_st - 64) << 1) | 1);
				}
			}
		}

		buffer_cpu_to_be64((u64 *)table, 2 * N_QPS * CABAC_CTX_TABLE_BYTES / sizeof(u64));
	}
}

int hantro_h264_enc_init(struct hantro_ctx *ctx)
{
	struct hantro_dev *vpu = ctx->dev;
	struct hantro_aux_buf *aux_buf;
	unsigned int mb_width, mb_height, mb_total;
	int ret, i;

	mb_width = DIV_ROUND_UP(ctx->src_fmt.width, 16);
	mb_height = DIV_ROUND_UP(ctx->src_fmt.height, 16);
	mb_total = mb_width * mb_height;

	for (i = 0; i < HANTRO_H264_NUM_INTERNAL_FRAMES; ++i) {
		aux_buf = &ctx->h264_enc.luma_internal[i];
		aux_buf->size = mb_total * LUMA_MB_BYTES;
		aux_buf->cpu = dma_alloc_coherent(vpu->dev, aux_buf->size,
						  &aux_buf->dma, GFP_KERNEL);
		if (!aux_buf->cpu) {
			ret = -ENOMEM;
			goto err_free_luma_internal;
		}
	}

	for (i = 0; i < HANTRO_H264_NUM_INTERNAL_FRAMES; ++i) {
		aux_buf = &ctx->h264_enc.chroma_internal[i];
		aux_buf->size = N_CHROMA_PLANES * mb_total * CHROMA_MB_BYTES;
		aux_buf->cpu = dma_alloc_coherent(vpu->dev, aux_buf->size,
						  &aux_buf->dma, GFP_KERNEL);
		if (!aux_buf->cpu) {
			ret = -ENOMEM;
			goto err_free_chroma_internal;
		}
	}

	aux_buf = &ctx->h264_enc.nal_table;
	aux_buf->size = round_up(NAL_ENTRY_BYTES * (mb_height + 4), 8);
	aux_buf->cpu = dma_alloc_coherent(vpu->dev, aux_buf->size,
					  &aux_buf->dma, GFP_KERNEL);
	if (!aux_buf->cpu) {
		ret = -ENOMEM;
		goto err_free_chroma_internal;
	}

	for (i = 0; i < HANTRO_H264_CABAC_IDC_NUM; ++i) {
		aux_buf = &ctx->h264_enc.cabac_ctx[i];
		aux_buf->size = 2 * N_QPS * CABAC_CTX_TABLE_BYTES; /* 2: intra + inter */
		aux_buf->cpu = dma_alloc_coherent(vpu->dev, aux_buf->size,
						  &aux_buf->dma, GFP_KERNEL);
		if (!aux_buf->cpu) {
			ret = -ENOMEM;
			goto err_free_cabac_ctx;
		}
	}

	aux_buf = &ctx->h264_enc.mv_buf;
	aux_buf->size = mb_total * MB_MV_BYTES;
	aux_buf->cpu = dma_alloc_coherent(vpu->dev, aux_buf->size,
					  &aux_buf->dma, GFP_KERNEL);
	if (!aux_buf->cpu) {
		ret = -ENOMEM;
		goto err_free_cabac_ctx;
	}

	aux_buf = &ctx->h264_enc.segment_map;
	aux_buf->size = round_up(mb_total * MB_SEGMENTATION_BITS, 64) * 8;
	aux_buf->cpu = dma_alloc_coherent(vpu->dev, aux_buf->size,
					  &aux_buf->dma, GFP_KERNEL);
	if (!aux_buf->cpu) {
		ret = -ENOMEM;
		goto err_free_mv_buf;
	}

	h264_enc_init_cabac_table(ctx);

	ctx->h264_enc.last_prev_idx = -1;
	ctx->h264_enc.last_idx = -1;
	ctx->h264_enc.ltr_idx = -1;

	return 0;

err_free_mv_buf:
	dma_free_coherent(vpu->dev, ctx->h264_enc.mv_buf.size,
			  ctx->h264_enc.mv_buf.cpu,
			  ctx->h264_enc.mv_buf.dma);

err_free_cabac_ctx:
	while (--i >= 0)
		dma_free_coherent(vpu->dev, ctx->h264_enc.cabac_ctx[i].size,
				  ctx->h264_enc.cabac_ctx[i].cpu,
				  ctx->h264_enc.cabac_ctx[i].dma);

	dma_free_coherent(vpu->dev, ctx->h264_enc.nal_table.size,
			  ctx->h264_enc.nal_table.cpu,
			  ctx->h264_enc.nal_table.dma);
	i = HANTRO_H264_NUM_INTERNAL_FRAMES;

err_free_chroma_internal:
	while (--i >= 0)
		dma_free_coherent(vpu->dev, ctx->h264_enc.chroma_internal[i].size,
				  ctx->h264_enc.chroma_internal[i].cpu,
				  ctx->h264_enc.chroma_internal[i].dma);
	i = HANTRO_H264_NUM_INTERNAL_FRAMES;

err_free_luma_internal:
	while (--i >= 0)
		dma_free_coherent(vpu->dev, ctx->h264_enc.luma_internal[i].size,
				  ctx->h264_enc.luma_internal[i].cpu,
				  ctx->h264_enc.luma_internal[i].dma);

	return ret;
}
